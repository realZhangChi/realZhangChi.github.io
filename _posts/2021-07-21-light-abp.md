---
layout: post
title: "Abp太重了？轻量化的Abp框架"
subtitle: "轻量化的Abp框架"
author: "Chi"
date: 2021-07-21 22:00
header-style: text
catalog: true
tags:
  - Abp
---


在进行框架的选型时，经常会听到“***框架太重了”之类的声音，比如“Abp太重了，不适合我们...”。事实上，Abp框架真的很重吗？

框架的“轻”和“重”，我没有在网上找到明确的定义，通过阅读一些技术博客，大致可以把框架的“轻”和“重”通过以下几个方面进行区分：

- 所依赖程序集的数量
- 所实现的功能的多少
- 使用起来的简易程度

“轻量级”的框架，大概指的是一个程序集依赖少且程序集文件小、功能虽少但足够满足需求、上手容易使用简单的框架；“重量级”的框架，大概指的是一个程序集依赖多且程序集文件大、功能丰富但大多数用不到、上手困难且使用困难的框架。

这篇文章将从上述几个方面来探索Abp是一个“轻量级”还是“重量级”的框架。

## 最小依赖

Abp开发了一些启动模板来为我们生成项目。启动模板采用了[领域驱动设计](https://docs.abp.io/en/abp/latest/Domain-Driven-Design)的分层方案来建立项目层级，包括了**展示层**、**应用层**、**领域层**与**基础设施层**。

![Architecture](/img/in-post/2021-07-22-Lightweight-Abp/Architecture.png)

我们通常都会通过[Abp CLI](https://docs.abp.io/en/abp/latest/CLI)或Abp.io来创建类似上图架构的项目。Abp为我们生成的项目，减少了我们初始化项目的工作量，开箱即用，因此将我们可能会使用的Nuget包预先引入到我们的项目中，也就给我们一种依赖项太多的感觉。

![Dependency](/img/in-post/2021-07-22-Lightweight-Abp/Dependency.png)

从架构设计上来讲，**模块化**是Abp的核心；而从技术角度来看，**依赖注入**则是Abp实现众多功能的一个主要手段。只要了解Abp的模块化和依赖注入，我们就能够基于Abp框架来进行项目开发。

接下来将创建一个原生的`ASP.NET Core Web API`项目，围绕模块化和依赖注入两个核心概念，来展示如何以最小依赖的方式使用Abp。

1. 通过VS或者dotNet cli新建一个原生的`ASP.NET Core Web API`项目，命名为`LightweightAbp`；
2. 安装Nuget包`Volo.Abp.Autofac`和`Volo.Abp.AspNetCore.Mvc`；
3. 将项目进行**模块化**：在项目根目录新建一个Abp**模块**代码文件`LightweightAbpModule.cs`，并复制以下代码：

```C#
using Volo.Abp;
using Volo.Abp.AspNetCore.Mvc;
using Volo.Abp.Autofac;
using Volo.Abp.Modularity;

namespace LightweightAbp
{
    [DependsOn(
        typeof(AbpAutofacModule),
        typeof(AbpAspNetCoreMvcModule))]
    public class LightweightAbpModule : AbpModule
    {
        public override void ConfigureServices(ServiceConfigurationContext context)
        {
        }

        public override void OnApplicationInitialization(ApplicationInitializationContext context)
        {
        }
    }
}
```

4. 将`Startup`中的代码调整到`LightweightAbpModule`中，代码如下：

``` C#
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.OpenApi.Models;
using Volo.Abp;
using Volo.Abp.AspNetCore.Mvc;
using Volo.Abp.Autofac;
using Volo.Abp.Modularity;

namespace LightweightAbp
{
    [DependsOn(
        typeof(AbpAutofacModule),
        typeof(AbpAspNetCoreMvcModule))]
    public class LightweightAbpModule : AbpModule
    {
        public override void ConfigureServices(ServiceConfigurationContext context)
        {
            context.Services.AddControllers();
            context.Services.AddSwaggerGen(c =>
            {
                c.SwaggerDoc("v1", new OpenApiInfo { Title = "LightweightAbp", Version = "v1" });
            });
        }

        public override void OnApplicationInitialization(ApplicationInitializationContext context)
        {
            var app = context.GetApplicationBuilder();
            var env = context.GetEnvironment();

            if (env.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
                app.UseSwagger();
                app.UseSwaggerUI(c => c.SwaggerEndpoint("/swagger/v1/swagger.json", "LightweightAbp v1"));
            }

            app.UseRouting();

            app.UseAuthorization();

            app.UseEndpoints(endpoints =>
            {
                endpoints.MapControllers();
            });
        }
    }
}

```

5. 更改`Startup`中的代码以使用Abp的**模块化**系统：

``` C#
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;

namespace LightweightAbp
{
    public class Startup
    {
        public void ConfigureServices(IServiceCollection services)
        {
            services.AddApplication<LightweightAbpModule>();
        }

        public void Configure(IApplicationBuilder app, IWebHostEnvironment env, ILoggerFactory loggerFactory)
        {
            app.InitializeApplication();
        }
    }
}
```

6. 更改`Program`的`CreateHostBuilder`方法以使用Abp的**依赖注入**系统（基于Autofac）：

``` C#
public static IHostBuilder CreateHostBuilder(string[] args) =>
            Host.CreateDefaultBuilder(args)
                .ConfigureWebHostDefaults(webBuilder =>
                {
                    webBuilder.UseStartup<Startup>();
                })
                .UseAutofac();
```

7. 将项目生成的`WeatherForecastController`基类`ControllerBase`更改为`AbpController`。
8. 按`F5`运行。

至此项目的创建完成了。可以看到，仅仅依赖了`Volo.Abp.Autofac`和`Volo.Abp.AspNetCore.Mvc`两个Nuget包，即可利用Abp进行开发。若从所依赖Nuget包数量来评估框架的“轻”和“重”，那么Abp不可谓不轻。

### 功能按需使用

得益于**模块化**设计，Abp将其所能提供的功能，划分并封装到了不同的**模块**中。要想使用Abp提供的某一功能，只需引入提供这一功能的Nuget包并依赖此模块即可。
