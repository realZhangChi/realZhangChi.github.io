---
layout: post
title: "《CQRS Documents by Greg Young》翻译：传统架构"
subtitle: 'CQRS Documents by Greg Young - A Stereotypical Architecture'
author: "Chi"
date: 2020-04-28 14:00
header-style: text
catalog: true
tags:
  - Design Patterns
  - DDD
  - CQRS
---

在尝试将现有项目进行领取驱动设计之前，重要的是首先分析现有项目的架构，及其中所运用的技术知识。随后，我们可以尝试以较小的合理步骤改进既有体系结构，同时将进行改进的生产成本降至最低。

下面显示了一个典型的架构图：

![A Stereotypical Architecture](/img/in-post/2020-04-28-CQRS-A-Stereotypical-Architecture/a-stereotypical-architecture.jpg)

## 应用服务

上图中的体系结构的核心是数据存储设施（可以是关系型数据库、键值对数据库、对象存储或者XML文件），它存储了领域中对象的当前状态。

在数据存储设施之上的是应用服务，包含了系统逻辑。在这一层中进行数据验证和逻辑协调，处理发送过来的请求。

*值得注意的是，虽然上图没有数据层，但可以在应用服务和数据存储之间放置一个数据层。同样需要注意的是，实现这种架构，“领域模式”不是必须的，也可以使用其他模式，比如将表模块或事务脚本作为应用服务。*

抽象出 "领域"的概念，人们会发现一个被称为应用服务的结构。应用服务为领域和底层数据提供了一个简单的接口，它也限制了领域的调用者和领域本身之间的耦合。

应用服务之上会存在着客户端调用之类的设施，比如TCP/IP通信等。

用应用服务来抽象出系统的数据存储，并提供业务逻辑，这几年来已经非常流行，在写这篇文章的时候，在很多情况下被认为是应用于很多系统的默认架构。

## 客户端交互

与应用服务交互的是客户端，交互过程见下图：

![Typical Client Interaction](/img/in-post/2020-04-28-CQRS-A-Stereotypical-Architecture/typical-client-interaction.jpg)

客户端的基本交互可以说是`DTO`（数据传输对象）的传输过程。我们可以从一个操作的执行过程来分析应用服务的功能。一个用户在客户端上编辑客户信息：客户端向应用服务端发送请求，请求一个标识客户的`DTO`，应用服务端加载所需的领域对象，并将领域对象映射到`DTO`，然后返回给客户端。这个`DTO`包含了领域对象的状态。

客户端将在屏幕上显示应用服务端返回的信息，允许用户和其进行编辑等交互。用户将完成对数据的编辑，并通过某些操作（保存按钮）将编辑后的数据保存到系统中。

保存操作将用户编辑过的界面数据转换为`DTO`，并将其传回应用服务端。服务端接收到`DTO`之后，将`DTO`映射为领域对象，领域对象验证更改，并将变更后的数据保存到数据库。服务端将会返回给客户端“保存成功”或错误信息等消息。

## 架构分析

上面提到的架构及任何其他架构都有自己的特点，这些特点在某些时候非常适应我们的项目，但是在一些其他情况下可能很糟糕。

### 简洁性

在分析架构时，重要的是要注意对于给定的体系结构来说最显著的特征是什么。在上面的架构中，最有可能定义其受欢迎程度的特点就是它很简单。一个人可以教初级开发人员如何在很短的时间内与使用这种架构构建的系统进行交互。除了简单之外，该体系结构是完全通用的。一个人可以在每个项目上使用这种架构。除了可以在每个项目上使用它之外，所以如果团队聘用了新成员，则新成员可能会非常熟悉其系统的总体体系结构，从而再次降低了启动成本。

### 工具

有许多框架可用于优化利用上述架构创建系统所需的时间。ORM是最大的例子，因为它们提供了有价值的服务，如变更跟踪和事务管理等。其他的例子还包括自动映射框架，它们在领域对象及`DTO`之间进行映射，从而在很大程度上消除了在应用服务器中来回映射`DTO`所需的代码。

当然上面提供的架构中也有很多不好的地方，比如不能在其中应用领域驱动设计。

### 领域驱动设计

虽然很多"实践"领域驱动设计的人都在使用上述架构，但将领域驱动设计应用到次架构上是不可能的。至于为什么不可能的原因，只要看看Ubiquitous Language是如何用对象模型来表示的，就不难看出。

在上面的架构中，只有四个操作`Create`、`Read`、`Update`和`Delete`，或者说是业界通常所说的CRUD。因为客户端有一个面向数据的接口，所以应用服务也必然有同样的接口。

这意味着，在领域内没有其他动词。然而，当一个人在与领域专家交谈时，在努力完善Ubiquitous Language的时候，极少有人会以这四个动词为中心的语言结束。

有一个相关的著名的反模式领域建模被称为"贫血模型"。

>“贫血域模型的基本症状是，乍一看它看起来确实像真实世界对象的抽象。在领域模型中有许多以名词命名的对象，这些对象与真实领域模型所具有的丰富关系和结构相关联。当您查看行为时就会发现问题所在，您意识到这些对象几乎没有任何行为，只有一堆getter和setter。 实际上，这些模型经常带有设计规则，这些规则说您不应将任何领域逻辑放入领域对象中。而是有一组服务对象处理所有领域逻辑。这些服务以领域模型为基础，并使用领域模型存储数据”。（Fowler，2003）

这个架构所建立的模型，乍听起来是一个贫血领域的模型。因为应用服务将数据来回映射到`DTO`，所以领域对象几乎没有什么行为，而且在映射过程中会有大量的`getter`和`setter`。领域有一个结构，显示了对象之间的关系，但这个架构中不是这样。

在这种架构下，我们甚至不能贫血领域模型，因为所有的业务逻辑都在服务中，这里的服务本身只是将`DTO`映射到域对象，没有实际的业务逻辑。在这种情况下，大量的业务逻辑根本就不存在于领域中，也不存在于应用服务器中，它可能存在于客户端，但更可能存在于手册中的纸片上，或者是在使用系统的人的头脑中。

### 扩展性

这个架构在扩展性上有一个大瓶颈，在扩展方面的瓶颈是数据存储。目前大部分系统使用的是关系型数据库，大多数数据库在这一点上是不具备水平扩展能力的，而且垂直扩展的成本很快就会变得非常昂贵。然而，大多数系统不需要扩展，因此在有些情况下，可扩展性并不是一个严重的问题。

## 总结

许多项目中使用的“`DTO`传输”架构能够用于许多应用，并能为团队的工作提供许多简单的好处。但是，它不能用于基于领域驱动设计的项目中。

然而，这个体系结构确实是一个很好的开始，本文的其余部分将集中在如何一步步地改进这个体系结构，同时尝试在每一个步骤中限制或消除成本，增加业务价值。

## 参考

> [Fowler, M. (2003, 11 25). MF Bliki: AnemicDomainModel.](http://martinfowler.com/bliki/anemicdomainmodel)
> [CQRS Documents by Greg Young](https://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf)
